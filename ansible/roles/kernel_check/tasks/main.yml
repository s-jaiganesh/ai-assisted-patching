---
- block:
    - ansible.builtin.command: uname -r
      register: running_kernel
      changed_when: false

    - ansible.builtin.shell: "rpm -q kernel --qf '%{VERSION}-%{RELEASE}.%{ARCH}\n' | sort -V | tail -n 1"
      register: latest_kernel
      changed_when: false
      become: true

    - ansible.builtin.set_fact:
        _running: "{{ running_kernel.stdout | trim }}"
        _latest: "{{ latest_kernel.stdout | trim }}"
        _is_latest: "{{ (running_kernel.stdout | trim) == (latest_kernel.stdout | trim) }}"

    - ansible.builtin.set_fact:
        step_status: "{{ 'success' if _is_latest else 'failed' }}"
        step_reason: "{{ 'OK' if _is_latest else 'NOT_LATEST_KERNEL' }}"
        step_summary: "running={{ _running }}, latest={{ _latest }}"
        step_payload: { running: "{{ _running }}", latest: "{{ _latest }}", is_latest: "{{ _is_latest }}" }

  rescue:
    - ansible.builtin.set_fact:
        step_status: failed
        step_reason: KERNEL_CHECK_FAILED
        step_summary: "{{ ansible_failed_result.msg | default('kernel check failed') }}"
        step_payload: { msg: "{{ ansible_failed_result.msg | default('') }}" }

  always:
    - include_role: { name: roles_common/db_writer }
      vars:
        step: kernel_check
        status: "{{ step_status }}"
        reason_code: "{{ step_reason }}"
        summary: "{{ step_summary }}"
        payload: "{{ step_payload }}"

    - include_role: { name: roles_common/drupal_update }
      vars: { dashboard_phase: kernel_check }
      when: (dashboard_refresh_each_step | default(false)) | bool
      run_once: true